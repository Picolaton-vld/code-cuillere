<%- include('partials/header') %>
<main class="container">
  <div class="card post">
    <div class="post-header">
      <img src="<%= post.userId.avatar || '/images/default-avatar.jpg' %>" alt="Avatar" class="avatar">
      <span class="username"><%= post.userId.username %></span>
      <% if (post.location && post.location.name) { %>
        <span class="location"><i class="fas fa-map-marker-alt"></i> <%= post.location.name %></span>
      <% } %>
      <% if (currentUser && post.userId._id.toString() === currentUser._id.toString()) { %>
        <span class="post-actions-btns">
          <a href="/post/<%= post._id %>/edit" class="btn btn-edit"><i class="fas fa-edit"></i> Modifier</a>
          <form action="/post/<%= post._id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce post ?');">
            <button type="submit" class="btn btn-delete"><i class="fas fa-trash"></i></button>
          </form>
        </span>
      <% } %>
    </div>
    <% if (post.images && post.images.length > 0) { %>
      <% post.images.forEach(function(img) { %>
        <img src="<%= img %>" alt="Photo de cuillère" class="post-image-fullwidth" style="max-width:300px;display:block;margin-bottom:8px;">
      <% }); %>
    <% } %>
    <div class="post-caption">
      <strong><%= post.userId.username %></strong> <%= post.caption %>
    </div>

  <!-- Boutons de partage jolis et bien alignés -->
<style>
  .share-buttons {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: .7em;
    margin: 1.2em 0 .7em 0;
  }
  .share-buttons span {
    font-weight: bold;
    margin-right: 0.3em;
  }
  .share-buttons a,
  .share-buttons button {
    display: inline-flex;
    align-items: center;
    border: none;
    background: none;
    cursor: pointer;
    padding: .15em .4em;
    border-radius: 4px;
    font-size: 1em;
    text-decoration: none;
    transition: background 0.15s;
    color: #1877f2;
  }
  .share-buttons a img {
    width: 24px;
    height: 24px;
    margin-right: 0.25em;
    vertical-align: middle;
  }
  .share-buttons a[title~="X"] { color: #1da1f2; }
  .share-buttons a[title~="WhatsApp"] { color: #25d366; }
  .share-buttons a[title~="Instagram"] { color: #C13584; }
  .share-buttons a[title~="Snapchat"] { color: #FFFC00; }
  .share-buttons button {
    color: #333;
    border: 1px solid #ccc;
    background: #f8f8f8;
    margin-left: .4em;
    font-size: .98em;
    transition: background 0.1s;
  }
  .share-buttons button:hover {
    background: #e7e7e7;
  }
  .share-buttons .qr-btn {
    border: 1px solid #1877f2;
    color: #1877f2;
    background: #fff;
    font-weight: 500;
    margin-left: .6em;
    padding: .18em .7em;
    font-size: .96em;
    transition: background 0.12s;
  }
  .share-buttons .qr-btn:hover {
    background: #f0f5ff;
  }
  @media (max-width: 600px) {
    .share-buttons {
      flex-direction: column;
      align-items: flex-start;
      gap: .5em;
    }
    .share-buttons button,
    .share-buttons .qr-btn {
      margin-left: 0;
    }
  }
</style>
<div class="share-buttons">
  <span>Partager&nbsp;:</span>
  <!-- Facebook -->
  <a href="https://www.facebook.com/sharer/sharer.php?u=<%= encodeURIComponent(request.protocol + '://' + request.get('host') + '/post/' + post._id) %>" target="_blank" rel="noopener" title="Partager sur Facebook">
    <img src="/images/facebook.svg" alt="Facebook"/>Facebook
  </a>
  <!-- X -->
  <a href="https://twitter.com/intent/tweet?url=<%= encodeURIComponent(request.protocol + '://' + request.get('host') + '/post/' + post._id) %>&text=Découvrez ce post sur SpoonGram !" target="_blank" rel="noopener" title="Partager sur X">
    <img src="/images/X.svg" alt="X"/>X
  </a>
  <!-- WhatsApp -->
  <a href="https://wa.me/?text=<%= encodeURIComponent(request.protocol + '://' + request.get('host') + '/post/' + post._id) %>" target="_blank" rel="noopener" title="Partager sur WhatsApp">
    <img src="/images/whatsapp.svg" alt="WhatsApp"/>WhatsApp
  </a>
  <!-- Instagram (pas d'API direct, ouvre le site) -->
  <a href="https://www.instagram.com/" target="_blank" rel="noopener" title="Partager sur Instagram">
    <img src="/images/instagram.svg" alt="Instagram"/>Instagram
  </a>
  <!-- Snapchat -->
  <a href="https://www.snapchat.com/scan?attachmentUrl=<%= encodeURIComponent(request.protocol + '://' + request.get('host') + '/post/' + post._id) %>" target="_blank" rel="noopener" title="Partager sur Snapchat">
    <img src="/images/snapchat.svg" alt="Snapchat"/>Snapchat
  </a>
  <!-- Copier le lien -->
  <button onclick="navigator.clipboard.writeText('<%= request.protocol + '://' + request.get('host') + '/post/' + post._id %>');this.innerText='Copié!';setTimeout(()=>this.innerText='Copier le lien',1000)">Copier le lien</button>
  <!-- QR code -->
  <a href="/post/<%= post._id %>/qrcode" target="_blank" class="qr-btn">Partager localisation</a>
</div>
    <div class="comments">
      <h3>Commentaires</h3>
      <% function renderComments(comments, parentId, level) { %>
        <% comments.filter(c => String(c.parentId) === String(parentId)).forEach(c => { %>
          <div style="margin-left:<%= level*32 %>px; border-left:1.5px solid #eee; padding-left:14px; margin-top:10px;">
            <strong>
              <a href="/user/<%= c.userId && c.userId._id ? c.userId._id : '#' %>">
                <%= c.userId && c.userId.username ? c.userId.username : "[Utilisateur]" %>
              </a>
            </strong>
            <span style="color:#bbb; font-size:0.9em;">
              <%= c.createdAt ? new Date(c.createdAt).toLocaleString() : "" %>
            </span><br>
            <%= c.text %>
            <!-- Bouton répondre (affiche le formulaire) -->
            <% if (currentUser) { %>
              <a href="#" onclick="event.preventDefault();document.getElementById('reply-<%= c._id %>').style.display='block';">Répondre</a>
              <form id="reply-<%= c._id %>" action="/comment/<%= post._id %>" method="POST" style="display:none; margin-top:8px;">
                <input type="hidden" name="parentId" value="<%= c._id %>">
                <input type="text" name="comment" placeholder="Votre réponse..." required style="width:70%;">
                <button type="submit" style="padding:3px 12px;">Envoyer</button>
              </form>
            <% } %>
            <% renderComments(comments, c._id, level+1); %>
          </div>
        <% }) %>
      <% } %>
      <% renderComments(post.comments, null, 0); %>
    </div>

    <% if (currentUser) { %>
      <form class="comment-form" action="/comment/<%= post._id %>" method="POST" style="margin-top:18px;">
        <input type="text" name="comment" placeholder="Ajouter un commentaire..." required>
        <button type="submit">Publier</button>
      </form>
    <% } %>
  </div>
</main>
