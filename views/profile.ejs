<%- include('partials/header') %>
<main class="container">
  <div class="profile-header">
    <img src="<%= user.avatar || '/images/default-avatar.jpg' %>" alt="Avatar" style="width:100px;height:100px;border-radius:50%;">
    <div class="profile-info">
      <h2><%= user.username %></h2>
      <div class="profile-stats">
        <div class="profile-stat">
          <strong><%= posts.length %></strong> publications
        </div>
      </div>
    </div>
  </div>
  <form action="/profile/avatar" method="POST" enctype="multipart/form-data">
    <input type="file" name="avatar" accept="image/*" required>
    <button type="submit">Mettre à jour l'avatar</button>
  </form>
  <div class="profile-posts">
    <% posts.forEach(function(post) { %>
      <div class="post-card">
        <!-- Début du carrousel -->
        <div class="carousel" data-post="<%= post._id %>">
          <button class="carousel-prev" onclick="prevSlide('<%= post._id %>')" type="button">&#8249;</button>
          <div class="carousel-images">
            <% post.images.forEach(function(img, idx) { %>
              <img src="<%= img %>" alt="Image du post" class="carousel-image <%= idx === 0 ? 'active' : '' %>" data-idx="<%= idx %>">
            <% }) %>
          </div>
          <button class="carousel-next" onclick="nextSlide('<%= post._id %>')" type="button">&#8250;</button>
        </div>
        <!-- Fin du carrousel -->
        <div class="post-caption">
          <strong><%= post.userId.username %></strong>
          <span><%= post.caption %></span>
        </div>
        <div class="post-actions">
          <form action="/like/<%= post._id %>" method="POST" style="display:inline;">
            <button type="submit" class="like-btn">
              <%= post.likes && post.likes.some(function(like) { return like.equals(user._id); }) ? "💖" : "🤍" %>
            </button>
          </form>
          <span><%= post.likes.length %> likes</span>
        </div>
        <div class="post-comments">
          <% post.comments.forEach(function(comment) { %>
            <div class="comment">
              <strong><%= comment.userId && comment.userId.username ? comment.userId.username : "Utilisateur" %></strong>
              <span><%= comment.text %></span>
            </div>
          <% }) %>
          <form action="/comment/<%= post._id %>" method="POST" class="comment-form">
            <input type="text" name="comment" placeholder="Ajouter un commentaire..." required>
            <button type="submit">Publier</button>
          </form>
        </div>
        <div class="profile-post-actions">
          <a href="/post/<%= post._id %>/edit" class="btn btn-edit"><i class="fas fa-edit"></i></a>
          <form action="/post/<%= post._id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Supprimer ce post ?');">
            <button type="submit" class="btn btn-delete"><i class="fas fa-trash"></i></button>
          </form>
        </div>
      </div>
    <% }); %>
  </div>
</main>
<%- include('partials/footer') %>

<!-- Ajoute le JS du carrousel -->
<script>
function nextSlide(postId) {
  const carousel = document.querySelector('.carousel[data-post="'+postId+'"]');
  const images = carousel.querySelectorAll('.carousel-image');
  let current = Array.from(images).findIndex(img => img.classList.contains('active'));
  images[current].classList.remove('active');
  let next = (current + 1) % images.length;
  images[next].classList.add('active');
}
function prevSlide(postId) {
  const carousel = document.querySelector('.carousel[data-post="'+postId+'"]');
  const images = carousel.querySelectorAll('.carousel-image');
  let current = Array.from(images).findIndex(img => img.classList.contains('active'));
  images[current].classList.remove('active');
  let prev = (current - 1 + images.length) % images.length;
  images[prev].classList.add('active');
}
</script>

<!-- Ajoute le CSS minimaliste pour le carrousel (à déplacer dans ton fichier CSS principal si tu préfères) -->
<style>
.carousel {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 300px;
  height: 300px;
  overflow: hidden;
  margin-bottom: 10px;
}
.carousel-images img {
  display: none;
  max-width: 100%;
  max-height: 100%;
  margin: 0 auto;
}
.carousel-images img.active {
  display: block;
}
.carousel-prev, .carousel-next {
  background: rgba(0,0,0,0.4);
  color: #fff;
  border: none;
  font-size: 2em;
  width: 40px;
  height: 40px;
  cursor: pointer;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 2;
  border-radius: 50%;
}
.carousel-prev { left: 5px; }
.carousel-next { right: 5px; }
</style>
