<%- include('partials/header') %>
<main class="container">
  <form action="/search" method="GET" class="search-bar" style="display:flex;gap:8px;margin-bottom:20px;">
    <input type="text" name="q" value="<%= q %>" placeholder="Rechercher (lieu, pseudo, #hashtag, légende...)" style="flex:1;padding:8px;">
    <button type="submit"><i class="fas fa-search"></i> Rechercher</button>
  </form>
  <h2>Résultats pour "<%= q %>"</h2>

  <% if (users && users.length > 0) { %>
    <h3>Comptes trouvés :</h3>
    <ul style="margin-bottom:24px;">
      <% users.forEach(user => { %>
        <li style="margin-bottom:8px;">
          <a href="/user/<%= user._id %>" style="display:flex;align-items:center;gap:8px;">
            <img src="<%= user.avatar || '/images/default-avatar.jpg' %>" alt="Avatar" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;">
            <span><%= user.username %></span>
          </a>
<% if (currentUser && currentUser._id.toString() !== user._id.toString() && !user.followers.some(f => f.toString() === currentUser._id.toString())) { %>
  <form action="/follow/<%= user._id %>" method="POST" style="display:inline;">
    <button type="submit">S'abonner</button>
  </form>
<% } %>
<% if (currentUser && currentUser._id.toString() !== user._id.toString() && user.followers.some(f => f.toString() === currentUser._id.toString())) { %>
  <form action="/unfollow/<%= user._id %>" method="POST" style="display:inline;">
    <button type="submit">Se désabonner</button>
  </form>
<% } %>
        </li>
      <% }) %>
    </ul>
  <% } %>

  <div class="posts">
    <% if (posts.length === 0) { %>
      <p>Aucun résultat trouvé.</p>
    <% } %>
    <% posts.forEach(post => { %>
      <div class="card post">
        <div class="post-header">
          <img src="<%= post.userId.avatar || '/images/default-avatar.jpg' %>" alt="Avatar" class="avatar">
          <span class="username">
            <a href="/user/<%= post.userId._id %>"><%= post.userId.username %></a>
          </span>
          <% if (post.location && post.location.name) { %>
            <span class="location"><i class="fas fa-map-marker-alt"></i> <%= post.location.name %></span>
          <% } %>
        </div>
        <% if (post.images && post.images[0]) { %>
          <img src="<%= post.images[0] %>" style="max-width:270px;">
        <% } %>
        <div class="post-caption">
          <strong>
            <a href="/user/<%= post.userId._id %>"><%= post.userId.username %></a>
          </strong> <%= post.caption %>
        </div>
      </div>
    <% }); %>
  </div>
</main>
<%- include('partials/footer') %>
