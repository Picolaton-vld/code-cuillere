<%- include('partials/header') %>
<style>
  .post-actions-bottom-right {
    position: absolute;
    right: 18px;
    bottom: 18px;
    display: flex;
    gap: 10px;
    z-index: 2;
  }
  .btn-post-edit, .btn-post-delete {
    padding: 7px 16px;
    border-radius: 22px;
    font-weight: 600;
    font-size: 1em;
    border: none;
    cursor: pointer;
    transition: background .18s, color .18s, box-shadow .18s;
    box-shadow: 0 1px 4px #0001;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  .btn-post-edit {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #90caf9;
  }
  .btn-post-edit:hover {
    background: #bbdefb;
    color: #1565c0;
  }
  .btn-post-delete {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
  }
  .btn-post-delete:hover {
    background: #ffcdd2;
    color: #fff;
  }
  .post-card {
    position: relative;
    padding-bottom: 50px; /* espace pour les boutons */
  }
</style>
<main class="container">
  <div class="profile-header">
    <img src="<%= user.avatar || '/images/default-avatar.jpg' %>" alt="Avatar" style="width:100px;height:100px;border-radius:50%;">
    <div class="profile-info">
      <h2><%= user.username %></h2>
      <div class="profile-stats">
        <div class="profile-stat">
          <strong><%= posts.length %></strong> publications
        </div>
        <div class="profile-stat">
          <strong><%= user.followers ? user.followers.length : 0 %></strong> abonnés
        </div>
        <div class="profile-stat">
          <strong><%= user.following ? user.following.length : 0 %></strong> abonnements
        </div>
      </div>
      <% if (currentUser && currentUser._id.toString() !== user._id.toString()) { %>
        <% 
          const isFollowing = user.followers.some(f => 
            (f._id ? f._id.toString() : f.toString()) === currentUser._id.toString()
          );
        %>
        <% if (isFollowing) { %>
          <form action="/unfollow/<%= user._id %>" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-unfollow">Se désabonner</button>
          </form>
        <% } else { %>
          <form action="/follow/<%= user._id %>" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-follow">S’abonner</button>
          </form>
        <% } %>
      <% } %>
    </div>
  </div>
  <div class="profile-posts">
    <% if (posts.length === 0) { %>
      <p>Aucune publication pour le moment.</p>
    <% } %>
    <% posts.forEach(function(post) { %>
      <div class="post-card">
        <% if (post.images && post.images[0]) { %>
          <img src="<%= post.images[0] %>" style="max-width:200px;">
        <% } %>
        <div>
          <strong><%= user.username %></strong>
          <span><%= post.caption %></span>
        </div>
        <a href="/post/<%= post._id %>">Voir le post</a>
      </div>
    <% }); %>
  </div>
</main>
<%- include('partials/footer') %>

<style>
.btn-follow {
  background: #2d87f0; color: #fff; padding: 6px 14px; border-radius: 4px; border:none; cursor:pointer;
}
.btn-unfollow {
  background: #ccc; color: #333; padding: 6px 14px; border-radius: 4px; border:none; cursor:pointer;
}
</style>
